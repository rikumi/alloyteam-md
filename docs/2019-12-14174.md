---
title: First Meaningful Paint 首次有效绘制时间
date: 2019-12-31
author: TAT.cooperliang
source_link: http://www.alloyteam.com/2019/12/14174/
---

<!-- {% raw %} - for jekyll -->

# 前言

最近在研究网站测速相关的主题，接触到一个概念：[**First Meaningful Paint**](https://docs.google.com/document/d/1BR94tJdZLsin5poeet0XoTW60M0SjvOJQttKT-JK8HI/view?hl=zh-cn#)，简称 **FMP**，中文译名：**首次有效绘制时间**。今天我们来讲讲这个概念的来龙去脉。

# 衡量页面打开速度是一件复杂的事情

First Meaningful Paint（以下简称 FMP），是谷歌创造的一个概念，用来**更好地**衡量页面打开的速度。你可能会说，要衡量页面打开速度，不是已经有 [DOMContentLoaded Event](https://developer.mozilla.org/en-US/docs/Web/API/Window/DOMContentLoaded_event) 和 [OnLoad Event](https://developer.mozilla.org/en-US/docs/Web/API/Window/load_event) 了吗？为什么还要搞一个新概念？  
答案是：**因为随着 Web 应用越来越复杂，DOMContentLoaded Event 和 OnLoad Event 已经越来越难以准确表现页面的打开速度了。**

举个例子：

````html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
    <h1>这里是直出的内容</h1>
    <img src="https://avatars3.githubusercontent.com/u/8401872" alt="">
    <hr/>
    <h1>下面是异步加载的内容</h1>
    <div id="app"></div>
    
```html
<script>
        setTimeout(() => {
            for (let i = 0; i < 100; i++) {
                let newDiv = document.createElement("div");
                let newContent = document.createTextNode("异步回来的内容" + i);
                newDiv.appendChild(newContent);
                document.querySelector('#app').appendChild(newDiv);
            }
        }, 200);
    </script>
````

</body>
</html>
```

在这个例子中，html 中有直出的内容，也有一张图片，script 中用 setTimeout 模拟一个 Ajax 请求，数据返回后插入到页面中。像这种类型的页面非常常见，我们通过 Chrome 的 Performance 可以看到它的打开效果和速度。

![Demo](https://user-images.githubusercontent.com/8401872/67560604-cae41b00-f74d-11e9-9095-706835195f15.gif)

![image](https://user-images.githubusercontent.com/8401872/67553715-653d6200-f740-11e9-8d5d-b3d7e2abb8bd.png)

观察 Timings，可以看到**在打开页面的过程中依次触发了 DOMContentLoaded -> First Paint ->First Contentful Paint -> OnLoad -> First Meaningful Paint**。我们尝试来解释一下。

1.  浏览器首先加载解析 HTML，HTML 加载解析完成后，触发 **DOMContentLoaded Event**。此时浏览器尚未开始渲染，其他静态资源，比如图片等也还没加载。
2.  浏览器开始渲染直出的 HTML，触发 **First Paint** 和 **First Contentful Paint**，用户开始看到文字。此时图片尚未加载回来，所以还不能看到图片。  
    PS：关于 First Paint 和 First Contentful Paint，网上的资料很少，我也没完全搞明白这两者的定义和区别。我大致是这样理解的：浏览器要开始渲染的时候，会先触发 First Paint，当渲染出第一个 DOM（比如文字或者图片等 DOM 元素）的时候，就会触发 First Contentful Paint。这两个概念并非本文的重点，更多的详细解析，请参考 [W3C 的定义](https://w3c.github.io/paint-timing/#first-paint)。
3.  浏览器把图片加载回来了，所有资源都加载完成，触发 **OnLoad Event**。
4.  setTimeout 定时器触发，往页面中写入大量 DOM，触发 **First Meaningful Paint**。

那么问题来了，这里有 5 个指标，**应该用哪个指标来衡量页面打开速度呢？**  
DOMContentLoaded 肯定不行，因为�


<!-- {% endraw %} - for jekyll -->