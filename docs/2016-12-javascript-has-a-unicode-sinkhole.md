---
title: Javascript æœ‰ä¸ª Unicode çš„å¤©å‘
date: 2016-12-04
author: TAT.will
source_link: http://www.alloyteam.com/2016/12/javascript-has-a-unicode-sinkhole/
---

<!-- {% raw %} - for jekyll -->

* * *

æœ€è¿‘ç¬”è€…åœ¨é¡¹ç›®ä¸­é‡åˆ°äº† emoji è¡¨æƒ…çš„å¤„ç†ï¼ŒæœŸé—´å‘ç° js å¤„ç†å¤šå­—èŠ‚å­—ç¬¦æ—¶ä¼šæœ‰è¾ƒå¤šå‘ï¼Œè®°å½•ä¸€ä¸‹ä¸å„ä½åˆ†äº«ã€‚  
æœ¬æ–‡æ¶‰åŠçŸ¥è¯†ç‚¹ï¼š

> Unicode (BMP/SP)  
> UTF-8 UTF-16 UTF-32 UCS-2  
> javascript å­—ç¬¦å¤„ç†

## Unicode

Unicode æ˜¯ç›®å‰ç»å¤§å¤šæ•°ç¨‹åºä½¿ç”¨çš„å­—ç¬¦ç¼–ç ï¼Œå®šä¹‰ä¹Ÿå¾ˆç®€å•ï¼Œç”¨ä¸€ä¸ªç ç‚¹ (code point) æ˜ å°„ä¸€ä¸ªå­—ç¬¦ã€‚ç ç‚¹å€¼çš„èŒƒå›´æ˜¯ä» U+0000 åˆ° U+10FFFFï¼Œå¯ä»¥è¡¨ç¤ºè¶…è¿‡ 110 ä¸‡ä¸ªç¬¦å·ã€‚ä¸‹é¢æ˜¯ä¸€äº›ç¬¦å·ä¸å®ƒä»¬çš„ç ç‚¹

-   `A` çš„ç ç‚¹ U+0041
-   `a` çš„ç ç‚¹ U+0061
-   `Â©`çš„ç ç‚¹ U+00A9
-   `â˜ƒ`çš„ç ç‚¹ U+2603
-   `ğŸ’©`çš„ç ç‚¹ U+1F4A9

å¯¹äºæ¯ä¸ªç ç‚¹ï¼ŒUnicode è¿˜ä¼šé…ä¸Šä¸€å°æ®µæ–‡å­—è¯´æ˜ï¼Œå¯ä»¥åœ¨ codepoints.net æŸ¥åˆ°ï¼Œæ¯”å¦‚ [ğŸ’©çš„ç ç‚¹è¯´æ˜](https://codepoints.net/U+1F4A9)

Unicode æœ€å‰é¢çš„ 65536 ä¸ªå­—ç¬¦ä½ï¼Œç§°ä¸ºåŸºæœ¬å¹³é¢ï¼ˆBMP-â€”Basic Multilingual Planeï¼‰ï¼Œå®ƒçš„ç ç‚¹èŒƒå›´æ˜¯ä» U+0000 åˆ° U+FFFFã€‚æœ€å¸¸è§çš„å­—ç¬¦éƒ½æ”¾åœ¨è¿™ä¸ªå¹³é¢ï¼Œè¿™æ˜¯ Unicode æœ€å…ˆå®šä¹‰å’Œå…¬å¸ƒçš„ä¸€ä¸ªå¹³é¢ã€‚  
å‰©ä¸‹çš„å­—ç¬¦éƒ½æ”¾åœ¨è¡¥å……å¹³é¢ï¼ˆSupplementary Planeï¼‰ï¼Œç ç‚¹èŒƒå›´ä» U+010000 ä¸€ç›´åˆ° U+10FFFFï¼Œå…± 16 ä¸ªã€‚

## UTF ä¸ UCS

UTFï¼ˆUnicode transformation formatï¼‰Unicode è½¬æ¢æ ¼å¼ï¼Œæ˜¯æœåŠ¡äº Unicode çš„ï¼Œç”¨äºå°†ä¸€ä¸ª Unicode ç ç‚¹è½¬æ¢ä¸ºç‰¹å®šçš„å­—èŠ‚åºåˆ—ã€‚å¸¸è§çš„ UTF æœ‰

> UTF-8 å¯å˜å­—èŠ‚åºåˆ—ï¼Œç”¨ 1 åˆ° 4 ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªç ç‚¹  
> UTF-16 å¯å˜å­—èŠ‚åºåˆ—ï¼Œç”¨ 2 æˆ– 4 ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªç ç‚¹  
> UTF-32 å›ºå®šå­—èŠ‚åºåˆ—ï¼Œç”¨ 4 ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªç ç‚¹

[UTF-8](https://en.wikipedia.org/wiki/UTF-8) å¯¹ ASCâ…¡ ç¼–ç æ˜¯å…¼å®¹çš„ï¼Œéƒ½æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œè¶…è¿‡ U+07FF çš„éƒ¨åˆ†åˆ™ç”¨äº†å¤æ‚çš„è½¬æ¢æ–¹å¼æ¥æ˜ å°„ Unicodeï¼Œå…·ä½“ä¸å†è¯¦è¿°ã€‚

UTF-16 å¯¹äº BMP çš„ç ç‚¹ï¼Œé‡‡ç”¨ 2 ä¸ªå­—èŠ‚è¿›è¡Œç¼–ç ï¼Œè€Œ BMP ä¹‹å¤–çš„ç ç‚¹ï¼Œç”¨ 4 ä¸ªå­—èŠ‚ç»„æˆä»£ç†å¯¹ï¼ˆsurrogate pairï¼‰æ¥è¡¨ç¤ºã€‚å…¶ä¸­å‰ä¸¤ä¸ªå­—èŠ‚èŒƒå›´æ˜¯ U+D800 åˆ° U+DBFFï¼Œåä¸¤ä¸ªå­—èŠ‚èŒƒå›´æ˜¯ U+DC00 åˆ° U+DFFFï¼Œé€šè¿‡ä»¥ä¸‹å…¬å¼å®Œæˆæ˜ å°„ï¼ˆHï¼šé«˜å­—èŠ‚ Lï¼šä½å­—èŠ‚ cï¼šç ç‚¹ï¼‰  
H = Math.floor((c-0x10000) / 0x400)+0xD800  
L = (c - 0x10000) % 0x400 + 0xDC00

æ¯”å¦‚ğŸ’©ç”¨ UTF-16 è¡¨ç¤ºå°±æ˜¯ "\\uD83D\\uDCA9"

UCSï¼ˆUniversal Character Setï¼‰é€šç”¨å­—ç¬¦é›†ï¼Œæ˜¯ä¸€ä¸ª ISO æ ‡å‡†ï¼Œç›®å‰ä¸ Unicode å¯ä»¥è¯´æ˜¯ç­‰ä»·çš„ã€‚  
ç›¸å¯¹äº UTFï¼ŒUCS ä¹Ÿæœ‰è‡ªå·±çš„è½¬æ¢æ–¹æ³•ï¼ˆç¼–ç ï¼‰ã€‚å¦‚

> UCS-2 ç”¨ 2 ä¸ªå­—èŠ‚è¡¨ç¤º BMP çš„ç ç‚¹  
> UCS-4 ç”¨ 4 ä¸ªå­—èŠ‚è¡¨ç¤ºç ç‚¹

UCS-2 æ˜¯ä¸€ä¸ªè¿‡æ—¶çš„ç¼–ç æ–¹å¼ï¼Œå› ä¸ºå®ƒåªèƒ½ç¼–ç åŸºæœ¬å¹³é¢ï¼ˆBMP) çš„ç ç‚¹ï¼Œåœ¨ BMP çš„ç¼–ç ä¸Šï¼Œä¸ UTF-16 æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥å¯ä»¥è®¤ä¸ºæ˜¯ UTF-16 çš„ä¸€ä¸ªå­é›†ã€‚  
UCS-4 åˆ™ä¸ UTF-32 ç­‰ä»·ï¼Œéƒ½æ˜¯ç”¨ 4 ä¸ªå­—èŠ‚æ¥ç¼–ç  Unicodeã€‚

## javascript å­—ç¬¦å¤„ç†

è¾£è«ï¼Œjs åˆ°åº•æ˜¯ç”¨çš„å•¥ç¼–ç å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ UCS-2ã€‚å’¦ï¼Œåˆšåˆšä¸æ˜¯è¯´ UCS-2 è¿‡æ—¶äº†å—ï¼Ÿé¦–å…ˆçœ‹ä¸‹å¹´è¡¨

> 1990 UCS-2 è¯ç”Ÿ  
> 1995.5 JavaScript è¯ç”Ÿ  
> 1996.7 UTF-16 è¯ç”Ÿ

ä¹Ÿå°±æ˜¯è¯´ï¼ŒBrendan Eich åœ¨å†™ JS çš„æ—¶å€™ï¼ŒUTF-16 è¿˜æ²¡é—®ä¸–ï¼Œæ‰€ä»¥åªèƒ½ç”¨ UCS-2 çš„æ–¹å¼æ¥å¤„ç†å­—ç¬¦ï¼Œä¹Ÿå› æ­¤ç•™ä¸‹äº†éšæ‚£ã€‚

### å‘ 1â€”â€”length å±æ€§

å…ˆçœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š

> \>"\\uD83D\\uDCA9" === "ğŸ’©"  
> >true  
> >"ğŸ’©".length  
> >2

å› ä¸º "ğŸ’©" åœ¨ JS çš„ç¼–ç æ˜¯ "\\uD83D\\uDCA9"ï¼Œè€Œ JS è®¤ä¸ºæ¯ 16 ä½ (2 å­—èŠ‚ï¼‰å³è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥ä¸€å¨å¤§ä¾¿æ˜¯å  2 ä¸ªå­—ç¬¦çš„ã€‚æˆ‘ä»¬ç»å¸¸ç”¨ length æ¥åˆ¤æ–­å­—ç¬¦ä¸²é•¿åº¦ï¼Œé‚£äº§å“ä¸å¹²äº†å‘€ï¼Œè¯´å¥½å¯ä»¥è¾“å…¥ 10 ä¸ªå­—ï¼Œä¸ºæ¯›è¾“äº† 5 ä¸ª emoji å°±ä¸ç»™è¾“å…¥äº†ï¼Ÿ  
æ€ä¹ˆç ´ï¼Ÿå¯ä»¥ç”¨ä¸‡èƒ½çš„æ­£åˆ™åŒ¹é…

```javascript
var regexAstralSymbols = /[\uD800-\uDBFF][\uDC00-\uDFFF]/g; // åŒ¹é…UTF-16çš„ä»£ç†å¯¹
function countSymbols(string) {
    return (
        // â€¦è¿™æ—¶å€™å–é•¿åº¦å°±å¦¥å¦¥çš„å•¦.
        string
            // æŠŠä»£ç†å¯¹æ”¹ä¸ºä¸€ä¸ªBMPçš„å­—ç¬¦.
            .replace(regexAstralSymbols, "_").length
    );
}
countSymbols("ğŸ’©"); // 1
```

### å‘ 2â€”â€” åè½¬å­—ç¬¦ä¸²

js é‡Œæ€ä¹ˆåè½¬ï¼ˆreverseï¼‰å­—ç¬¦ä¸²ï¼Ÿç›¸ä¿¡æœ‰äº›åŒå­¦å·²ç»æƒ³åˆ°äº†ä¸€ä¸ªæç®€çš„æ–¹æ¡ˆ

```javascript
function reverse(str) {
    return str.split("").reverse().join("");
}
```

js è™½æ²¡æœ‰ç›´æ¥çš„åè½¬å­—ç¬¦ä¸²çš„ APIï¼Œä½†æ˜¯æ•°ç»„æœ‰å•Šï¼Œè½¬æ•°ç»„åè½¬ä¹‹åå†è½¬å›å­—ç¬¦ä¸²ï¼Œå˜¿å˜¿å˜¿ï¼Œæ˜¯ä¸æ˜¯å¾ˆæœºæ™ºï¼Ÿè¿™æ—¶å€™ Unicode å¤§çˆ·åˆå‡ºæ¥æ‰“è„¸äº†ï¼šä½ ä»¬å‘ï¼Œsometimes naiveï¼  
æ‹¿åˆšæ‰çš„å‡½æ•°åè½¬å¸¦æœ‰ğŸ’©çš„å­—ç¬¦ä¸²è¯•è¯•

    reverse('è¿™æ˜¯ä¸€å¨ğŸ’©')
    "ï¿½ï¿½å¨ä¸€æ˜¯è¿™"

ï¿½çš„ Unicode ç ç‚¹æ˜¯ + UFFFDï¼Œé€šå¸¸ç”¨æ¥è¡¨ç¤º Unicode è½¬æ¢æ—¶æ— æ³•è¯†åˆ«çš„å­—ç¬¦ï¼ˆä¹Ÿå°±æ˜¯ä¹±ç ï¼‰  
å½“ğŸ’©ï¼ˆ\\uD83D\\uDCA9ï¼‰é€šè¿‡ä¸Šè¿°æ–¹æ³•åè½¬æ—¶ï¼Œå˜æˆ\\uDCA9\\uD83Dï¼Œä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„ä»£ç†å¯¹ï¼ˆé«˜ä½å­—èŠ‚èŒƒå›´ä¸åŒï¼‰ï¼ŒåŒæ—¶ï¼ŒUnicode è§„å®šä»£ç†å¯¹èŒƒå›´å†…çš„ç ç‚¹ä¸èƒ½å•ç‹¬å‡ºç°ï¼Œæ‰€ä»¥ js åªèƒ½ç”¨ï¿½è¡¨ç¤ºäº†ã€‚  
æ€ä¹ˆç ´ï¼Ÿ

1.  ES6 çš„ Array.from æ”¯æŒä»£ç†å¯¹çš„è§£æ

```javascript
function reverse(string) {
    return Array.from(string).reverse().join("");
}
```

1.  ä½¿ç”¨ [Esrever](https://github.com/mathiasbynens/esrever)ï¼ˆreverse åè½¬ä¹‹åå°±æ˜¯ esrever...)

### å‘ 3â€”â€” ç ç‚¹ä¸å­—ç¬¦äº’è½¬

String.fromCharCode å¯ä»¥å°†ä¸€ä¸ªç ç‚¹è½¬æ¢ä¸ºå­—ç¬¦ï¼Œæ¯”å¦‚

    String.fromCharCode(0x0041)
    'A'

ä½†è¶…è¿‡ BMP å¹³é¢çš„å°±è·ªäº†ã€‚

    >> String.fromCharCode(0x1F4A9) // U+1F4A9
    'ï’©' // U+F4A9, not U+1F4A9

äº‹å®ä¸Šè¿™ä¸ª API æ˜¯æ”¯æŒä¿©å‚æ•°çš„ï¼Œåˆ†åˆ«æ˜¯ä»£ç†å¯¹çš„é«˜ä½å­—èŠ‚ã€‚æ‰€ä»¥éœ€è¦é€šè¿‡å…¬å¼è®¡ç®—å‡ºå¯¹åº”çš„é«˜ä½å­—èŠ‚

    >> String.fromCharCode(0xD83D, 0xDCA9)
    'ğŸ’©' // U+1F4A9
    >> 'ğŸ’©'.charCodeAt(0)
    0xD83D

ä¸€ä¸ªå­—ï¼Œè›‹ç–¼ï¼  
æ€ä¹ˆç ´ï¼Ÿ ES6 å¤§æ³•å¥½ã€‚

    >> String.fromCodePoint(0x1F4A9)
    'ğŸ’©' // U+1F4A9
    >> 'ğŸ’©'.codePointAt(0)
    0x1F4A9

### å‘ 4â€”â€” æ­£åˆ™åŒ¹é…

æ­£åˆ™åŒ¹é…ç¬¦`.` åªèƒ½åŒ¹é…å•ä¸ª â€œå­—ç¬¦â€ï¼Œä½† js å°†ä»£ç†å¯¹å½“æˆä¸¤ä¸ªå•ç‹¬çš„ â€œå­—ç¬¦â€ å¤„ç†ï¼Œæ‰€ä»¥åŒ¹é…ä¸åˆ°ä»»ä½•è¾…åŠ©å¹³é¢å­—ç¬¦ã€‚

    >> /foo.bar/.test('fooğŸ’©bar')
    false

æ€è€ƒä¸€ä¸‹ï¼Œä»€ä¹ˆæ­£åˆ™è¡¨è¾¾å¼å¯ä»¥è¡¨ç¤ºä»»ä½• Unicode å­—ç¬¦ï¼Ÿ æ˜¾ç„¶`.` æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºå®ƒä¸èƒ½åŒ¹é…è¾…åŠ©å¹³é¢å­—ç¬¦æˆ–è€…æ¢è¡Œç¬¦ã€‚é‚£ä¹ˆç”¨\\s\\S å‘¢ï¼Ÿ

    ```
    >> /^[\s\S]$/.test('ğŸ’©')
    false
    ```

æ€€ç–‘äººç”Ÿäº†ï½ï½æ­£ç¡®çš„åŒ¹é…ä»»æ„ Unicode å­—ç¬¦çš„æ­£åˆ™å¦‚ä¸‹ï¼š

    >> /[\0-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/.test('ğŸ’©') // wtf
    true

æ€ä¹ˆç ´ï¼Ÿ ES6 ç»™å‡ºä¸€ä¸ªç®€å•çš„æ–¹æ³• â€”â€” å¢åŠ ä¸€ä¸ª u æ ‡å¿—

    >> /foo.bar/u.test('fooğŸ’©bar')
    true

æ³¨æ„ï¼šè¿™é‡Œçš„`.` è¿˜æ˜¯ä¸èƒ½åŒ¹é…æ¢è¡Œç¬¦ã€‚

## ES6 çš„ Unicode æ”¯æŒ

ä»ä¸Šé¢çš„ä¾‹å­ä¸­å¯ä»¥çœ‹å‡ºï¼ŒES6 å·²ç»åœ¨å¾ˆåŠªåŠ›åœ°å¡«å‘äº†ã€‚å¯¹äº Unicode å­—ç¬¦ï¼ŒES6 æ”¯æŒæ–°çš„è¡¨ç¤ºæ–¹æ³•  
`\u{1F4A9}` åŠ ä¸ŠèŠ±æ‹¬å·åï¼Œå¯ä»¥æŠŠç ç‚¹ç›´æ¥å¡«è¿›å»æ¥è¡¨ç¤ºï¼Œè€Œä¸ç”¨å»è®¡ç®—ä»£ç†å¯¹ã€‚å†è¡¥å…… 2 ç‚¹ï¼š  
1. ä¸ºäº†å‘åå…¼å®¹ï¼Œå­—ç¬¦ä¸²çš„ length å±æ€§è¿˜æ˜¯ç”¨åŒå­—èŠ‚åˆ¤æ–­çš„ï¼Œæ‰€ä»¥è¦ç”¨ Array.from (str).lengthã€‚  
2. éå†å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨ `for(let s of str) {}`

å‚è€ƒèµ„æ–™ï¼š  
[Unicode ä¸ JavaScript è¯¦è§£](http://www.ruanyifeng.com/blog/2014/12/unicode.html)  
[JavaScript has a Unicode problem](https://mathiasbynens.be/notes/javascript-unicode)


<!-- {% endraw %} - for jekyll -->