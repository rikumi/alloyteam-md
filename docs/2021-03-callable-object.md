---
title: callable-object
date: 2021-03-14
author: TAT.vorshen
source_link: http://www.alloyteam.com/2021/03/callable-object/
---

<!-- {% raw %} - for jekyll -->

åŸæ–‡åœ°å€ï¼š<https://github.com/vorshen/blog/blob/master/callable-object/index.md>  
ä»Šå¤©æˆ‘ä»¬æ¥èŠä¸€èŠå¯è°ƒç”¨å¯¹è±¡ï¼Œä»åº•å±‚æ¥è¯´ï¼Œè°ƒç”¨æ˜¯æŒ‡æ–°å»ºäº†æ ˆå¸§ï¼Œå¯„å­˜å™¨æŒ‡å‘å‘ç”Ÿäº†å˜åŒ–ã€‚  
ä»ç›´è§‚ä¸Šçœ‹å¯ä»¥åŠ  () æ‰§è¡Œçš„å°±æ˜¯å¯è°ƒç”¨å¯¹è±¡ï¼æ¯”å¦‚æˆ‘ä»¬ç†Ÿæ‚‰çš„ javascript ä¸­å‡½æ•°ã€‚

## javascript ä¸­çš„ callable

```javascript
function drink() {
    console.log("åˆ©åˆ©ä¸æµæ³ªï¼Œå–é…’å–åˆ°é†‰");
}
drink();
```

ä½†æ˜¯æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œä¸ºä»€ä¹ˆè¿™æ®µä»£ç å¯ä»¥æŒ‰é¡ºåºæ‰§è¡Œï¼Ÿå¦‚æœäº†è§£ C æˆ–è€… Javaï¼Œç¨‹åºçš„å…¥å£ä¸€å®šæ˜¯ä¸€ä¸ª main å‡½æ•°ï¼Œä¸ºä»€ä¹ˆ js ä¸­æ— éœ€ main å‡½æ•°äº†å‘¢ï¼Ÿ

ä» v8 æºç ä¸€æ¢ç©¶ç«Ÿï¼Œè¿™æ˜¯å› ä¸º v8 ä¼šå°†æ•´ä¸ª js ä»£ç ï¼ŒåŒ…è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œæºç ä½ç½®å¦‚ä¸‹ï¼š

```c
// v8/src/execution/execution.cc
Â 
// ...
// â—code éå¸¸é‡è¦
Handle<Code> code =
Â Â Â Â Â Â JSEntry(isolate, params.execution_target, params.is_construct);
Â Â {
Â Â Â Â // ...
Â 
Â Â Â Â if (params.execution_target == Execution::Target::kCallable) {
Â Â Â Â Â Â // clang-format off
Â Â Â Â Â Â // {new_target}, {target}, {receiver}, return value: tagged pointers
Â Â Â Â Â Â // {argv}: pointer to array of tagged pointers
Â Â Â Â Â Â using JSEntryFunction = GeneratedCode<Address(
Â Â Â Â Â Â Â Â Â Â Address root_register_value, Address new_target, Address target,
Â Â Â Â Â Â Â Â Â Â Address receiver, intptr_t argc, Address** argv)>;
Â Â Â Â Â Â // clang-format on
Â Â Â Â Â Â JSEntryFunction stub_entry =
Â Â Â Â Â Â Â Â Â Â JSEntryFunction::FromAddress(isolate, code->InstructionStart());
Â 
Â Â Â Â Â Â Address orig_func = params.new_target->ptr();
Â Â Â Â Â Â Address func = params.target->ptr();
Â Â Â Â Â Â Address recv = params.receiver->ptr();
Â Â Â Â Â Â Address** argv = reinterpret_cast<Address**>(params.argv);
Â Â Â Â Â Â RuntimeCallTimerScope timer(isolate, RuntimeCallCounterId::kJS_Execution);
Â Â Â Â Â Â // â—ä¸‹é¢æ˜¯çœŸæ­£çš„æ‰§è¡Œ
Â Â Â Â Â Â value = Object(stub_entry.Call(isolate->isolate_data()->isolate_root(),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  orig_func, func, recv, params.argc, argv));
Â Â Â Â // ...
```

Code å¯¹è±¡éå¸¸çš„é‡è¦ï¼Œè¿™ä¸ªå°±æ˜¯ v8 ä¸­å‡½æ•°æ‰§è¡Œçš„å…³é”®ï¼Œv8 ç›¸å…³åŸè¯æœ‰:

> Code describes objects with on-the-fly generated machine code.
>
> JSFunctions are pairs (context, function code), sometimes also called closures.

JSFunction (v8 å†…æ•°æ®ç±»å‹) ç›¸æ¯”è¾ƒ JSObject é‡å¤§çš„å·®å¼‚ä¹Ÿå°±æ˜¯å¤šäº† code å±æ€§ï¼Œè¿™ä¹Ÿå°±æ˜¯ Function å¯ä»¥æ‰§è¡Œï¼Œè€Œ Object æ— æ³•æ‰§è¡Œçš„åŸå› ã€‚

å…¶å®æˆ‘ä»¬å°†ä¸Šé¢åˆ—å­ä¸­çš„ js ä»£ç ï¼Œç¼–è¯‘æˆå­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥çœ‹å‡ºæ¥æ•´ä¸ªæ–‡æœ¬å¯ä»¥æ‰§è¡Œçš„åŸå› ã€‚

    [generated bytecode for function:Â Â (0x06c008212561 <SharedFunctionInfo>)] // æ³¨æ„ç‚¹1
    Parameter count 1
    Register count 3
    Frame size 24
    Â Â Â Â Â Â Â Â  0x6c008212626 @Â Â Â Â 0 : 12 00Â Â Â Â Â Â Â Â Â Â Â Â  LdaConstant [0]
    Â Â Â Â Â Â Â Â  0x6c008212628 @Â Â Â Â 2 : 26 f9Â Â Â Â Â Â Â Â Â Â Â Â  Star r1
    Â Â Â Â Â Â Â Â  0x6c00821262a @Â Â Â Â 4 : 27 fe f8Â Â Â Â Â Â Â Â Â Â Mov <closure>, r2
    Â Â Â Â Â Â Â Â  0x6c00821262d @Â Â Â Â 7 : 62 3f 01 f9 02Â Â Â Â CallRuntime [DeclareGlobals], r1-r2
    Â Â Â Â Â Â Â Â  0x6c008212632 @Â Â  12 : 13 01 00Â Â Â Â Â Â Â Â Â Â LdaGlobal [1], [0]
    Â Â Â Â Â Â Â Â  0x6c008212635 @Â Â  15 : 26 f9Â Â Â Â Â Â Â Â Â Â Â Â  Star r1
    Â Â Â Â Â Â Â Â  0x6c008212637 @Â Â  17 : 5d f9 02Â Â Â Â Â Â Â Â Â Â CallUndefinedReceiver0 r1, [2] // æ³¨æ„ç‚¹3
    Â Â Â Â Â Â Â Â  0x6c00821263a @Â Â  20 : 26 faÂ Â Â Â Â Â Â Â Â Â Â Â  Star r0
    Â Â Â Â Â Â Â Â  0x6c00821263c @Â Â  22 : abÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Return 
    Constant pool (size = 2)
    Handler Table (size = 0)
    Source Position Table (size = 0)
    Â 
    [generated bytecode for function: drink (0x06c0082125b9 <SharedFunctionInfo drink>)] // æ³¨æ„ç‚¹2
    Parameter count 1
    Register count 3
    Frame size 24
    Â Â Â Â Â Â Â Â  0x6c00821278a @Â Â Â Â 0 : 13 00 00Â Â Â Â Â Â Â Â Â Â LdaGlobal [0], [0]
    Â Â Â Â Â Â Â Â  0x6c00821278d @Â Â Â Â 3 : 26 f9Â Â Â Â Â Â Â Â Â Â Â Â  Star r1
    Â Â Â Â Â Â Â Â  0x6c00821278f @Â Â Â Â 5 : 28 f9 01 02Â Â Â Â Â Â  LdaNamedProperty r1, [1], [2]
    Â Â Â Â Â Â Â Â  0x6c008212793 @Â Â Â Â 9 : 26 faÂ Â Â Â Â Â Â Â Â Â Â Â  Star r0
    Â Â Â Â Â Â Â Â  0x6c008212795 @Â Â  11 : 12 02Â Â Â Â Â Â Â Â Â Â Â Â  LdaConstant [2]
    Â Â Â Â Â Â Â Â  0x6c008212797 @Â Â  13 : 26 f8Â Â Â Â Â Â Â Â Â Â Â Â  Star r2
    Â Â Â Â Â Â Â Â  0x6c008212799 @Â Â  15 : 5a fa f9 f8 04Â Â Â Â CallProperty1 r0, r1, r2, [4]
    Â Â Â Â Â Â Â Â  0x6c00821279e @Â Â  20 : 0dÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LdaUndefined 
    Â Â Â Â Â Â Â Â  0x6c00821279f @Â Â  21 : abÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Return 
    Constant pool (size = 3)
    Handler Table (size = 0)
    Source Position Table (size = 0)

æ²¡æ¥è§¦è¿‡å­—èŠ‚ç ä¹Ÿæ²¡å…³ç³»ï¼Œä»ä¸Šé¢è‡³å°‘èƒ½çœ‹åˆ° _generated bytecode for function_ å‡ºç°äº†ä¸¤æ¬¡ï¼Œæ„å‘³ç€æœ‰ä¸¤ä¸ªå‡½æ•°ã€‚  
**æ³¨æ„ç‚¹ 2** é‚£é‡Œæœ‰ä¸€ä¸ª drink å…³é”®å­—ï¼Œä»£è¡¨æ˜¯æˆ‘ä»¬æ˜¾ç¤ºå£°æ˜çš„å‡½æ•°ï¼›**æ³¨æ„ç‚¹ 1** é‚£é‡Œå°±æ˜¯æ•´æ®µ js ä»£ç ï¼Œè¢«ä½œä¸ºäº†ä¸€ä¸ªåŒ¿åå‡½æ•°æ‰§è¡Œã€‚  
_æ³¨æ„ç‚¹ 3 å°±æ˜¯è°ƒç”¨ drink çš„åœ°æ–¹ã€‚_

ä¸è¿‡ js æœ¬èº«æ˜¯ä¸€ä¸ªå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ï¼Œå‡½æ•°å¼æ˜¯å¦‚ä½•è¡¨ç°çš„æˆ‘ä»¬ä¸ç”¨å¤šè¯´ï¼Œé‡ç‚¹è¯´ä¸€è¯´ã€Œé—­åŒ…ã€ï¼Œé—­åŒ…ä¸€è¯ä¸å¯èƒ½æœ‰å‰ç«¯å¼€å‘ä¸çŸ¥é“ (_å“ªæ€•æ²¡ç”¨è¿‡ï¼Œé¢è¯•ä¹Ÿé‡åˆ°è¿‡_)ï¼Œé‚£æˆ‘ä»¬æ€è€ƒä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆé—­åŒ…å¯ä»¥è·¨è¶Šæ ˆå¸§çš„é™åˆ¶ï¼Ÿ  
ä»¥ä¸‹é¢è¿™ä¸ªå‡½æ•°ä¸ºä¾‹:

```javascript
const drink = (function () {
    let flag = 0;
    return function () {
        if (++flag > 3) {
            console.log("åˆ©åˆ©å–ä¸åŠ¨äº†");
            return;
        }
        console.log("åˆ©åˆ©å¨å¨å¨");
    };
})();
drink();
```

å¦‚æœä½¿ç”¨ d8 è¾“å‡ºå­—èŠ‚ç ï¼Œå¯ä»¥çœ‹åˆ°æ€»å…±æœ‰ä¸‰ä¸ª generated bytecode for functionã€‚æ•´æ®µæ‰§è¡Œçš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å…ˆæŒ‰å¸¸ç†çŒœæµ‹ä¸€ä¸‹ï¼Œå‡½æ•°æ‰§è¡Œä½œç”¨åŸŸå˜åŒ–åº”è¯¥å¦‚ä¸‹:  
![](https://raw.githubusercontent.com/vorshen/blog/master/callable-object/assets/1.png)  
è¿™é‡Œæ€»å…±æœ‰ä¸‰ä¸ªé˜¶æ®µï¼Œé‡ç‚¹çœ‹åé¢ä¸¤ä¸ªã€‚

-   ç¬¬äºŒé˜¶æ®µæ˜¯æ‰§è¡Œäº†åŒ¿åçš„è‡ªæ‰§è¡Œå‡½æ•°ï¼Œæ­¤æ—¶å£°æ˜äº†ä¸€ä¸ª flag å˜é‡åœ¨å¯¹åº”çš„ä½œç”¨åŸŸã€‚
-   ç¬¬ä¸‰é˜¶æ®µæ˜¯æ‰§è¡Œ drink å‡½æ•°ï¼Œè¿™é‡Œç”¨åˆ°äº†ä¸¤ä¸ªå˜é‡ã€‚
    1.  consoleï¼Œæ¥è‡ªäºä¸Šå±‚çš„ä½œç”¨åŸŸï¼Œå¯ä»¥ç†è§£ã€‚
    2.  flagï¼Œè¿™ä¸ªå°±æ¯”è¾ƒè¯¡å¼‚äº†ï¼Œ**å› ä¸ºç†è®ºä¸Š flag åº”è¯¥éšç€åŒ¿åå‡½æ•°çš„æ‰§è¡Œç»“æŸé”€æ¯äº†æ‰å¯¹**ã€‚

è¿™é‡Œ v8 åšäº†å¤„ç†ï¼Œå½“è§£æè„šæœ¬çš„æ—¶å€™ï¼Œå‘ç°è¿™æ ·çš„æƒ…å†µï¼Œä¼šåœ¨åŒ¿åå‡½æ•°æ‰§è¡Œé˜¶æ®µå°† flag æ‹·è´åˆ°å †ä¸­ï¼Œå¹¶ä¸”ç»™ drink å‡½æ•°å¢åŠ ä¸€ä¸ª scope å¼•ç”¨ã€‚  
æ‰€ä»¥çœŸå®çš„å›¾åº”è¯¥æ˜¯è¿™æ ·ï¼š  
![](https://raw.githubusercontent.com/vorshen/blog/master/callable-object/assets/2.png)  
ä»å­—èŠ‚ç ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“ return çš„å‡½æ•°ä½¿æ²¡ä½¿ç”¨é—­åŒ…ï¼Œå­—èŠ‚ç æ˜¯æˆªç„¶ä¸åŒçš„ï¼Œå¦‚ä¸‹:

```javascript
// ä½¿ç”¨é—­åŒ…
const drink = (function() {
Â Â Â Â let i = 0;
Â Â Â Â return function() {
Â Â Â Â Â Â Â Â if (++i > 3) {
Â Â Â Â Â Â Â Â Â Â Â Â console.log('åˆ©åˆ©å–ä¸åŠ¨äº†');
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â console.log('åˆ©åˆ©å¨å¨å¨');
Â Â Â Â };
})();
Â 
drink();
/////////////////////////////////
// åŒ¿åå‡½æ•°å­—èŠ‚ç å¦‚ä¸‹
[generated bytecode for function:Â Â (0x3e97082125e9 <SharedFunctionInfo>)]
Parameter count 1
Register count 1
Frame size 8
Â Â Â Â Â Â Â Â  0x3e97082126d6 @Â Â Â Â 0 : 85 00 01Â Â Â Â Â Â Â Â Â Â CreateFunctionContext [0], [1]
Â Â Â Â Â Â Â Â  0x3e97082126d9 @Â Â Â Â 3 : 16 faÂ Â Â Â Â Â Â Â Â Â Â Â  PushContext r0
Â Â Â Â Â Â Â Â  0x3e97082126db @Â Â Â Â 5 : 0fÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LdaTheHole 
Â Â Â Â Â Â Â Â  0x3e97082126dc @Â Â Â Â 6 : 1d 02Â Â Â Â Â Â Â Â Â Â Â Â  StaCurrentContextSlot [2]
Â Â Â Â Â Â Â Â  0x3e97082126de @Â Â Â Â 8 : 0bÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â LdaZero 
Â Â Â Â Â Â Â Â  0x3e97082126df @Â Â Â Â 9 : 1d 02Â Â Â Â Â Â Â Â Â Â Â Â  StaCurrentContextSlot [2]
Â Â Â Â Â Â Â Â  0x3e97082126e1 @Â Â  11 : 82 01 00 02Â Â Â Â Â Â  CreateClosure [1], [0], #2
Â Â Â Â Â Â Â Â  0x3e97082126e5 @Â Â  15 : abÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Return 
Constant pool (size = 2)
Handler Table (size = 0)
Source Position Table (size = 0)
```

```javascript
// æœªä½¿ç”¨é—­åŒ…
let i = 0;
const drink = (function() {
Â Â Â Â return function() {
Â Â Â Â Â Â Â Â if (++i > 3) {
Â Â Â Â Â Â Â Â Â Â Â Â console.log('åˆ©åˆ©å–ä¸åŠ¨äº†');
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â console.log('åˆ©åˆ©å¨å¨å¨');
Â Â Â Â };
})();
Â 
drink();
/////////////////////////////////
// åŒ¿åå‡½æ•°å­—èŠ‚ç å¦‚ä¸‹
[generated bytecode for function:Â Â (0x11f5082125e9 <SharedFunctionInfo>)]
Parameter count 1
Register count 0
Frame size 0
Â Â Â Â Â Â Â Â  0x11f5082126d6 @Â Â Â Â 0 : 82 00 00 02Â Â Â Â Â Â  CreateClosure [0], [0], #2
Â Â Â Â Â Â Â Â  0x11f5082126da @Â Â Â Â 4 : abÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Return 
Constant pool (size = 1)
Handler Table (size = 0)
Source Position Table (size = 0)
```

ä½œç”¨åŸŸæŸ¥æ‰¾çš„ä»£ç åœ¨ <https://github.com/v8/v8/blob/master/src/ast/scopes.cc#L1975>ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚

## C++ ä¸­çš„ callable

å¦‚æœæŸ¥çœ‹ v8 æºç çš„åŒå­¦ï¼Œæ·±å…¥åˆ°æ‰§è¡Œ Code å…·ä½“æ‰§è¡Œï¼Œå‘ç°æœ€åæ˜¯é€šè¿‡ Adress ç±»å‹ï¼Œè€Œ Adress å°±æ˜¯è¡¨ç¤ºäº†ä¸€ä¸ªåœ°å€ï¼Œä¸‹é¢æ˜¯ v8 çš„ Adress æºç :

```c
typedef uintptr_t Address;
```

é‚£ä¹ˆåœ°å€å¯ä»¥æ‰§è¡Œä¹ˆï¼Ÿå½“ç„¶å¯ä»¥ï¼Œçœ‹å¦‚ä¸‹ C++ ä»£ç :

```c
void drink() {
Â Â Â Â printf("åˆ©åˆ©å¨å¨å¨ \n");
}
Â 
typedef unsigned long int uintptr_t;
Â 
int main(int argc, char* argv[]) {
Â Â Â Â uintptr_t t = (uintptr_t)drink;
Â Â Â Â ((void(*)(void))t)();
}
```

æˆ‘ä»¬æ²¡æœ‰é‡‡ç”¨æ˜¾å¼è°ƒç”¨çš„æ–¹å¼ï¼Œè€Œæ˜¯é‡‡å–äº†é€šè¿‡å‡½æ•°å…¥å£åœ°å€æ¥è°ƒç”¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ç§æ–¹å¼å’Œç›´æ¥è°ƒç”¨æ±‡ç¼–ä¸Šçš„å·®å¼‚ã€‚  
![](https://raw.githubusercontent.com/vorshen/blog/master/callable-object/assets/3.png)  
å·¦è¾¹æ˜¯é€šè¿‡åœ°å€è°ƒç”¨ï¼Œå³è¾¹æ˜¯ç›´æ¥è°ƒç”¨ï¼Œå¯ä»¥çœ‹åˆ°æ±‡ç¼–å±‚é¢éƒ½æ˜¯ call å‘½ä»¤ï¼Œåªæ˜¯å‡½æ•°æŒ‡é’ˆæ˜¯æ‰‹åŠ¨è·å–åœ°å€å†èµ‹åˆ°äº†å¯„å­˜å™¨ä¸­æ‰§è¡Œè€Œå·²ã€‚

è™½ç„¶ C++ ä¸æ˜¯å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ï¼Œæ— æ³•æ˜¾æ€§çš„ä¼ é€’å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“äº†å‡½æ•°å…¶å®å°±æ˜¯ä¸€ä¸ªåœ°å€ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨å‡½æ•°æŒ‡é’ˆè§£å†³ã€‚ç¤ºä¾‹ä»£ç å¾ˆç®€å•å°±ä¸è´´äº†ã€‚

å¯¹äº C++ å±‚é¢çš„ callableï¼Œé‚£å¯å°±å¹¿æ³›äº†ï¼Œåªè¦æ˜¯é‡è½½äº† operator () çš„å¯¹è±¡ï¼Œéƒ½å¯ä»¥æˆä¸º callableï¼Œå¦‚ä¸‹:

```javascript
class Yori {
public:
Â Â Â Â void operator()() const {
Â Â Â Â Â Â Â Â printf("åˆ©åˆ©å¨å¨å¨ \n");
Â Â Â Â }
};
Â 
int main() {
Â Â Â Â Yori lili;
Â Â Â Â lili();
}
```

æˆ‘ä»¬ä¸€èˆ¬ç§°ä¸ºè¿™ç§å¯¹è±¡ä¸º**å‡½æ•°å¯¹è±¡**ï¼Œè¿™ä¹Ÿæ˜¯ lambda è¡¨è¾¾å¼çš„åŸç†ï¼Œæ¯”å¦‚ä¸‹é¢ä¸¤ä¸ªæ‰§è¡Œæ–¹å¼ï¼ŒåŸç†æ˜¯ä¸€æ ·çš„ã€‚

```c
#define FUNC_BODY \
Â Â Â Â if (curr++ >= limit) { \
Â Â Â Â Â Â Â Â printf("åˆ©åˆ©å–ä¸åŠ¨äº† \n"); \
Â Â Â Â } else { \
Â Â Â Â Â Â Â Â printf("åˆ©åˆ©[%s]å¨å¨å¨ \n", type.c_str()); \
Â Â Â Â } \
Â 
class Yori {
public:
Â Â Â Â Yori() = delete;
Â Â Â Â Yori(int& curr, int limit): curr(curr), limit(limit) {}
Â 
Â Â Â Â void operator()(const string& type) { FUNC_BODY }
private:
Â Â Â Â int& curr;
Â Â Â Â int limit;
};
Â 
int main() {
Â Â Â Â int curr = 0;
Â Â Â Â int limit = 2;
Â Â Â Â string type("ä¸€æ¯");
Â 
Â Â Â Â // é€šè¿‡å‡½æ•°å¯¹è±¡çš„æ–¹å¼è¿›è¡Œ call
Â Â Â Â Yori lili_class(curr, limit);
Â Â Â Â lili_class(type);
Â Â Â Â lili_class(type);
Â Â Â Â lili_class(type);
Â 
Â Â Â Â // é€šè¿‡ lambda çš„æ–¹å¼è¿›è¡Œ call
Â Â Â Â auto lili_lambda = [&curr, limit](const string type)->void { FUNC_BODY };
Â Â Â Â lili_lambda(type);
Â Â Â Â lili_lambda(type);
Â Â Â Â lili_lambda(type);
}
```

ä¸è¿‡è¿˜æ˜¯ lambda åœ¨å†™æ³•ä¸Šæ–¹ä¾¿äº†å¾ˆå¤šï¼Œè€Œä¸” lambda åœ¨**æ²¡æœ‰æ•è·åœºæ™¯**ä¸‹ï¼Œæ˜¯å¯ä»¥ä½œä¸ºå‡½æ•°æŒ‡é’ˆè¿›è¡Œè°ƒç”¨çš„ã€‚

```c
typedef void (*callback) ();
Â 
void drink(callback func) { // å‡½æ•°æŒ‡é’ˆä½œä¸ºå½¢å‚
Â Â Â Â printf("åˆ©åˆ©å¨å¨å¨ \n");
Â Â Â Â func(); // æ‰§è¡Œå‡½æ•°æŒ‡é’ˆ
}
Â 
int main() {
Â Â Â Â drink([]() {}); // lambda è¡¨è¾¾å¼ä½œä¸ºå®å‚
Â Â Â Â int i = 0;
Â Â Â Â drink([&i]() {}); // å½“æœ‰æ•è·æ—¶ï¼ŒæŠ¥é”™! 
Â Â Â Â return 0;
}
```

ç¬¬ä¸€ä¸ª drink å¯ä»¥æ­£å¸¸æŒ‡å®šï¼Œç¬¬äºŒä¸ªå°±ä¸è¡Œäº†ï¼Œå› ä¸ºæ‹¥æœ‰æ•è·çš„ lambda è¡¨è¾¾å¼æ˜¯æ— æ³•è½¬æ¢ä¸ºå‡½æ•°æŒ‡é’ˆçš„ã€‚

> ä¸å­˜åœ¨ä» "lambda \[]void ()->void"åˆ°"callback" çš„é€‚å½“è½¬æ¢å‡½æ•°

å¯¹äºä¸Šé¢è¿™ç§æƒ…å†µï¼Œå¯ä»¥é‡‡ç”¨å‡½æ•°åŒ…è£…å™¨æ¨¡ç‰ˆï¼Œæˆ‘ä»¬åªéœ€è¦å°†ä¸Šé¢çš„ä»£ç æ”¹æˆè¿™æ ·å°±è¡Œ.

```c
void drink(function<void()> func) {
Â Â Â Â printf("åˆ©åˆ©å¨å¨å¨ \n");
Â Â Â Â func();
}
Â 
int main() {
Â Â Â Â int i = 0;
Â Â Â Â drink([&i]() {}); // æ•è·ä¹Ÿæ²¡äº‹äº†ï¼ŒğŸ›«ï¸
Â Â Â Â return 0;
}
```

ä¹‹æ‰€ä»¥å¯ä»¥è¿™ä¹Ÿï¼Œæ˜¯å› ä¸º function åªå…³å¿ƒä½ æ˜¯ä¸æ˜¯ callable çš„ï¼Œå¹¶ä¸åœ¨ä¹ä½ æœ¬èº«æ˜¯å¦‚ä½• call çš„ã€‚

## æ€»ç»“

ç®€å•åˆ†æäº†ä¸€ä¸‹ç¨‹åºä¸­çš„ callable å¯¹è±¡ï¼Œå¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå¯ä»¥ç•™è¨€è®¨è®ºï¼Œå¥¥åŠ›ç»™ã€‚


<!-- {% endraw %} - for jekyll -->