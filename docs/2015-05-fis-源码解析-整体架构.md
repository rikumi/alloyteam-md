---
title: FIS 源码解析 - 整体架构
date: 2015-05-08
author: TAT.casperchen
source_link: http://www.alloyteam.com/2015/05/fis%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90-%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84/
---

<!-- {% raw %} - for jekyll -->

## 序言

这里假设本文读者对 [FIS](http://fis.baidu.com/) 已经比较熟悉，如还不了解，可猛击[官方文档](http://fis.baidu.com/)。

虽然 FIS 整体的源码结构比较清晰，不过讲解起来也是个系统庞大的工程，笔者尽量的挑重点的讲。如果读者有感兴趣的部分笔者没有提到的，或者是存在疑惑的，可以在评论里跑出来，笔者会试着去覆盖这些点。

下笔匆忙，如有错漏请指出。

## Getting started

如在开始剖析 FIS 的源码前，有三点内容首先强调下，这也是解构 FIS 内部设计的基础。

1、 FIS 支持三个命令，分别是 `fis release`、`fis server`、`fis install`。当用户输入 `fis xx` 的时候，内部调用 `fis-command-release`、`fis-command-server`、`fis-command-install` 这三个插件来完成任务。同时，FIS 的命令行基于 `commander` 这个插件构建，熟悉这个插件的同学很容易看懂 FIS 命令行相关部分源码。

2、FIS 以 `fis-kernel` 为核心。`fis-kernel` 提供了 FIS 的底层能力，包含了一系列模块，如配置、缓存、文件处理、日志等。FIS 的三个命令，最终调用了这些模块来完成构建的任务。参考 `fis-kernel/lib/` 目录，下面对每个模块的大致作用做了简单备注，后面的文章再详细展开。

```html
lib/
├── cache.js    <span class="comment">// 缓存模块，提高编译速度</span>
├── compile.js    <span class="comment">// （单）文件编译模块</span>
├── config.js  <span class="comment">// 配置模块，fis.config </span>
├── file.js  <span class="comment">// 文件处理</span>
├── log.js <span class="comment">// 日志</span>
├── project.js  <span class="comment">// 项目相关模块，比如获取、设置项目构建根路径、设置、获取临时路径等</span>
├── release.js  <span class="comment">// fis release 的时候调用，依赖 compile.js 完成单文件编译。同时还完成如文件打包等任务。├── uri.js  // uri相关</span>
└── util.js  <span class="comment">// 各种工具函数</span>
 
```

3、FIS 的编译过程，最终可以拆解为细粒度的[单文件编译](http://fis.baidu.com/docs/more/fis-base.html#%E5%8D%95%E6%96%87%E4%BB%B6%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B)，理解了下面这张图，对于阅读 FIS 的源码有非常大的帮助。（主要是 `fis release` 这个命令）

![enter image description here](https://raw.githubusercontent.com/fouber/fis-wiki-img/master/workflow.png)

## 一个简单的例子：fis server open

开篇的描述可能比较抽象，下面我们来个实际的例子。通过这个简单的例子，我们可以对 FIS 的整体设计有个大致的印象。

下文以 `fis server open` 为例，逐步剖析 FIS 的整体设计。其实 FIS 比较精华的部分集中在 `fis release` 这个命令，不过 `fis server` 这个命令相对简单，更有助于我们从纷繁的细节中跳出来，窥探 FIS 的整体概貌。

假设我们已经安装了 FIS。好，打开控制台，输入下面命令，其实就是打开 FIS 的 server 目录

    fis server open
     

从 `package.json` 可以知道，此时调用了 `fis/bin/fis`，里面只有一行有效代码，调用 `fis.cli.run()`方法，同时将进程参数传进去。

```html
<span class="comment">#!/usr/bin/env node</span>
 
<span class="keyword">require</span>(<span class="string">'../fis.js'</span>).cli.run(process.argv);
 
```

接下来看下`../fis.js`。代码结构非常清晰。注意，笔者将一些代码给去掉，避免长串的代码影响理解。同时在关键处加了简单的注释


<!-- {% endraw %} - for jekyll -->