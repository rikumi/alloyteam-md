---
title: 小程序・云开发的云函数路由高级玩法
date: 2018-09-24
author: TAT.heyli
source_link: http://www.alloyteam.com/2018/09/13433/
---

<!-- {% raw %} - for jekyll -->

> 李成熙，腾讯高级工程师，专注于性能优化、工程化和小程序服务。[微博](https://weibo.com/leehkfs/) \| [知乎](https://www.zhihu.com/people/leehey/) \| [Github](https://github.com/lcxfs1991)

## 概念回顾

在掘金开发者大会上，在推荐实践那里，我有提到一种云函数的用法，我们可以将相同的一些操作，比如用户管理、支付逻辑，按照业务的相似性，归类到一个云函数里，这样比较方便管理、排查问题以及逻辑的共享。甚至如果你的小程序的后台逻辑不复杂，请求量不是特别大，完全可以在云函数里面做一个单一的微服务，根据路由来处理任务。

用下面三幅图可以概括，我们来回顾一下：

![](https://ask.qcloudimg.com/draft/1011618/rdef4ndpws.png)

比如这里就是传统的云函数用法，一个云函数处理一个任务，高度解耦。

![](https://ask.qcloudimg.com/draft/1011618/dp4mts7n9e.png)

第二幅架构图就是尝试将请求归类，一个云函数处理某一类的请求，比如有专门负责处理用户的，或者专门处理支付的云函数。

![](https://ask.qcloudimg.com/draft/1011618/4775ja12zs.png)

最后一幅图显示这里只有一个云函数，云函数里有一个分派任务的路由管理，将不同的任务分配给不同的本地函数处理。

## `tcb-router` 介绍及用法

为了方便大家试用，咱们腾讯云 Tencent Cloud Base 团队开发了 [tcb-router](https://github.com/TencentCloudBase/tcb-router)，云函数路由管理库方便大家使用。

那具体怎么使用 `tcb-router` 去实现上面提到的架构呢？下面我会逐一举例子。

**架构一**：一个云函数处理一个任务  
这种架构下，其实不需要用到 `tcb-router`，像普通那样写好云函数，然后在小程序端调用就可以了。

-   云函数

```javascript
// 函数 router
exports.main = (event, context) => {
    return {
        code: 0,
        message: 'success'
    };
}；
 
```

-   小程序端

```javascript
wx.cloud
    .callFunction({
        name: "router",
        data: {
            name: "tcb",
            company: "Tencent",
        },
    })
    .then((res) => {
        console.log(res);
    })
    .catch((e) => {
        console.log(e);
    });
```

**架构二**： 按请求给云函数归类  
此类架构就是将相似的请求归类到同一个云函数处理，比如可以分为用户管理、支付等等的云函数。

-   云函数


<!-- {% endraw %} - for jekyll -->