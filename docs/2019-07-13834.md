---
title: 从零到一，撸一个在线斗地主下篇
date: 2019-07-30
author: TAT.vorshen
source_link: http://www.alloyteam.com/2019/07/13834/
---

<!-- {% raw %} - for jekyll -->

上篇回顾：我们说了斗地主游戏的**渲染展示部分**，最后也讲了下 canvas 中交互的情况，下篇的重点就是**游戏逻辑**。

逻辑主要分成两块：**流程逻辑和扑克牌对比逻辑。**

github 地址：<https://github.com/vorshen/landlord>

![17 张牌，你能秒我？](https://raw.githubusercontent.com/vorshen/landlord/master/blog/img/1.png)

# 流程逻辑

## 分析

这里流程上的逻辑分为两部分，一个是场景切换，还有一个就是房间页中游戏进行的流程

先简单说下场景切换，我们这个斗地主游戏有如下三种场景切换

1.  首页 -> 大厅页
2.  大厅页 -> 房间页
3.  房间页 -> 大厅页

我们这里偷了懒，首页和大厅页没有用 canvas，直接上了 dom，写起来也很奔放，没有用框架。如果游戏想正式一点，千万不要这样。看起来首页和大厅页逻辑很简单，那是因为我们漏掉了很多点（时间真的不够。。）。

用一张图表现一下，我们漏掉的点：  
![demo 和正式游戏的差异](https://raw.githubusercontent.com/vorshen/landlord/master/blog/img/17.png)

在我们如此简化的背景下，如果说还有什么需要注意的，可能就两点

### 1、是否提前加载模块

比如当我们进入首页的时候，要不要把大厅页和房间页都初始化完毕？

这里我没有选择初始化，一定是真正使用到才会初始化。理由主要就是后面用到再初始化的开销并不大，可以接受。

**如果当遇到，某一个场景很复杂，切换需要较大的开销，可以考虑提前进行一些初始化的工作。**

### 2、销毁是真销毁还是隐藏

大厅页和房间页存在来回切换的情况，当发生大厅切换到房间的时候，可以选择将大厅页隐藏，也可以选择将大厅页销毁，后面用到再初始化。

这里我们选择只是将页面隐藏，也就是说当房间页第一次展示的时候，需要进行初始化（较大开销），以后再展示，就是很少的性能开销了。  
大概代码如下：

```javascript
/**
 * 房间展示，主要是生成stage
 * @param info 
 */
private _show(info: i_RoomShowOptions) {
    this._roomId = info.roomId;
 
    if (this._inited) {
        // 初始化过了，stage肯定初始化过了，直接展示
        this._stage.show();
    } else {
        // 第一次展示，初始化stage
        this._initStage();
 
        this._inited = true;
    }
 
    ……
}
```

具体代码在 Hall.ts 和 Room.ts 中

因为我们页面简单而且小，常驻的话对性能影响不大，如果打算常驻的页面展示率低或者隐藏运行也很占用资源，那还是推荐把真的干掉。

# 房间中流程

## 消息驱动

首先我们认为在房间中，流程的变化都是事件驱动，具体可以看下图：  
![房间中流程变化](https://raw.githubusercontent.com/vorshen/landlord/master/blog/img/18.png)

注意：右侧如果有箭头，意味着可能该阶段自己切换到该阶段（只是该阶段主角玩家发生变化）

在每个阶段，前端只能有对应的操作。那么每个阶段的切换，事件的发起者是谁呢？写代码的时候，我发现可以有两种模式进行阶段切换。

### 1、前端控制

以「叫地主阶段」->「抢地主阶段」为例，首先前端肯定知道游戏的轮转顺序（必须知道，因为布局就得考虑），轮转顺序是逆时针的。

当服务器下发一条「xx 叫地主的消息」后，前端可以知道

1.  接下来要进行抢地主阶段了
2.  xx 的下一个是 yy

**那么前端可以主动将状态转为「yy 进行抢地主状态」。**

这个没有问题，逻辑上也讲得通，而且乐观 UI 的思想，能让用户最快的感知到变化，理论上体验最佳。甚至！**可以节省与后台的传输，因为后台只需要下发「xx 叫地主」，都不需要下发「yy 进入到抢地主状态」了**。

不过情况不是这么简单…… 写代码过程中发现了些问题。

「叫地主阶段」->「抢地主阶段」没问题，走的通；「抢地主状态」->「抢地主状态」也没问题，走得通；**「抢地主阶段」->「出牌阶段」怎么办？**

我们可以在前端将每个玩家叫地主、抢地主的结果记录下来，然后保证和后端一样的逻辑，也可以得到这局游戏的地主是谁。但是地主获得的三张牌呢？这是一定要得从服务器获得的，出现了冲突，或者说前端无法完整实现的地方。

更明显的还有「准备阶段」->「叫地主阶段」，前端完全不知道谁是叫地主的，因为这个可能不按轮转顺序来。

到这里，**是不是我们也可以前端 + 后台配合的方式？**尝试了一下，并不好，这种组合的形式让代码变得难写，我不推荐这种方式。

**不过也不敢保证，也许是我写法上的问题，如果对这里有建议和想法，可以一起讨论。**

### 2、后台控制

所以我最后采用了后端精准控制的方式，一切都是以后台下发为准。

我选择「叫地主」之后，理论上可以将前端状态转到「下个人抢地主」，但是并没有，我一定得等到后台状态变化的消息才进行转换。

**注意：但是按钮，还是得提前反馈啊，否则网络延迟会让用户抓狂的。**

所以房间逻辑这里，整个流程，是靠后台消息进行驱动的。代码大概：

    private _addMessageListener() {
        // 对手进入
        this._app.network.addEventListener('Room.PlayerEnterRoom', this._playerEnterRoom);
     
        // 对手离开
        this._app.network.addEventListener('Room.PlayerLeaveRoom', this._playerLeaveRoom);
     
        // 监听玩家准备
        this._app.network.addEventListener('Room.PlayerReady', this._playerReady);
     
        // 进入叫地主阶段
        this._app.network.addEventListener('Room.EnterAskLandlord', this._enterAskLandlord);
     
        // 对手叫地主
        this._app.network.addEventListener('Room.PlayerAskLandlord', this._playerAskLandlord);
     
        // 进入抢地主阶段
        this._app.network.addEventListener('Room.EnterGrabLandlord', this._enterGrabLandlord


<!-- {% endraw %} - for jekyll -->